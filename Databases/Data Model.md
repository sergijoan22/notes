


**Normalization**: Organize data in tables to reduce data redundancy, duplication and improve integrity.


### Schemas
**Star schema**: Fact table related to several dimension tables
![alt text](images/star_schema.png)
**Snowflake schema**: Fact table related to several dimension tables and these related to other dimension tables with higher hierarchy (ej: Sales - City - Country)
![alt text](images/snwoflake_schema.png)

### Keys
**Surrogate key**: UID autogenerated by the database when the row is inserted.
**Alternate key**: Identificator that comes from the business. Help with traceability with the source data.


### Fact table

```sql
-- Lookup keys in dimension tables to load a Fact table
INSERT INTO Fact_Sales (DateKey, ProductKey, OrderID, Quantity, Price, LoadTime)
SELECT d.DateKey, p.ProductKey, o.OrderID, o.Quantity, o.Price, GETDATE()
FROM Order_Detail o
JOIN Dim_Date d ON o.OrderDate = d.Date
JOIN Dim_Product p ON o.ProductID = p.ProductID;
```

### Slowly changing dimensions
Dimension tables where the attibutes may change over time
- Type 0: Attibutes never change.
- Type 1: Changes in attributes overwrite previous values, no history track.
- Type 2: New records for changing attibutes.
![alt text](images/scd_type2.png)

```sql
-- To mantain a type 2 SCD

IF EXISTS (SELECT 1 FROM Dim_Products WHERE SourceKey = @ProductID AND IsActive = 'True')
BEGIN
    -- Existing product record
    UPDATE Dim_Products
    SET ValidTo = GETDATE(), IsActive = 'False'
    WHERE SourceKey = @ProductID AND IsActive = 'True';
END
ELSE
BEGIN
    -- New product record
    INSERT INTO Dim_Products (SourceKey, ProductName, StartDate, EndDate, IsActive)
    VALUES (@ProductID, @ProductName, GETDATE(), '9999-12-31', 'True');
END
```
- Type 3: History added as new column.
- Type 4: New dimension added.
- Type 5: When type 2 not feasible due to large size.
- Type 6: Combining types 2 and 3.

### Complementary tables

**Staging tables**: Temporary tables to manipulate data and load it elsewhere.


### Loading process
1. Ingest new data in a DL applying transformations if apply.
2. Load data from the DL to staging tables in a DWH remianing transformations.
3. Mantain dimension tables in the DWH with new data in the staging tables (Creating surrogate PK).
4. Load fact tables in the DWH from with new data in the staging tables (Checking dimension tables's surrogate PK).
5. Post-load optimization: Update indexes and table distribution stadistics (If these are not automatic).
6. Empty staging tables.